<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سلة المشتريات - AL_rahike</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111}
    .container{max-width:900px;margin:0 auto}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .qty-input{width:56px}
    .total-row{font-weight:700;text-align:right}
    .btn{padding:10px 14px;border:0;border-radius:6px;cursor:pointer}
    .btn-primary{background:#9b2a2a;color:#fff}
    .btn-danger{background:#333;color:#fff}
    .form-group{margin-bottom:10px}
    label{display:block;margin-bottom:6px}
    input,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
    .empty{padding:30px;text-align:center;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <h1>سلة المشتريات</h1>
    <div id="cartArea"></div>

    <h2>معلومات المشتري</h2>
    <form id="checkoutForm">
      <div class="form-group">
        <label>الاسم الكامل</label>
        <input type="text" id="fullname" required />
      </div>
      <div class="form-group">
        <label>العنوان</label>
        <textarea id="address" rows="2" required></textarea>
      </div>
      <div class="form-group">
        <label>رقم الهاتف</label>
        <input type="tel" id="phone" required />
      </div>
      <button type="submit" class="btn btn-primary">تأكيد الطلب و الدفع</button>
      <a href="index.html" id="clearCart" class="btn btn-danger" style="margin-left:8px">الصفحة الرئيسية</a>
    </form>

    <div id="message" style="margin-top:16px"></div>
  </div>

<script>
  const CART_KEY = 'al_rahike_cart_v1';

  function readCart() { 
    try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } 
    catch { return []; } 
  }
  function writeCart(cart) { 
    localStorage.setItem(CART_KEY, JSON.stringify(cart)); 
    renderCart(); 
  }

  function formatPrice(n) { 
    return n.toLocaleString() + ' DH'; 
  }

  function renderCart() {
    const area = document.getElementById('cartArea');
    const cart = readCart();
    if (!cart || cart.length === 0) {
      area.innerHTML = '<div class="empty">السلة فارغة — أضف منتجات من الصفحة الرئيسية.</div>';
      return;
    }

    let html = '<table><thead><tr><th>المنتج</th><th>سعر الوحدة</th><th>كمية</th><th>المجموع</th><th></th></tr></thead><tbody>';
    cart.forEach((it, idx) => {
      const lineTotal = (it.price || 0) * (it.qty || 1);
      html += `<tr data-idx="${idx}">
        <td>${escapeHtml(it.name)}</td>
        <td>${formatPrice(it.price)}</td>
        <td><input class="qty-input" type="number" min="1" value="${it.qty || 1}" data-idx="${idx}"></td>
        <td class="line-total">${formatPrice(lineTotal)}</td>
        <td><button class="remove-btn" data-idx="${idx}">حذف</button></td>
      </tr>`;
    });
    const subtotal = cart.reduce((s,i) => s + (i.price * (i.qty||1)), 0);
    html += `</tbody></table>
      <div class="total-row" style="margin-top:12px">المجموع: <strong id="subtotal">${formatPrice(subtotal)}</strong></div>`;
    area.innerHTML = html;

    // ربط أحداث تغيير الكمية و الحذف
    document.querySelectorAll('.qty-input').forEach(inp => {
      inp.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.idx,10);
        const newQty = Math.max(1, parseInt(e.target.value || '1',10));
        const cart = readCart();
        cart[idx].qty = newQty;
        writeCart(cart);
      });
    });
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = parseInt(e.target.dataset.idx,10);
        let cart = readCart();
        cart.splice(idx,1);
        writeCart(cart);
      });
    });
  }

  // دالة إرسال رسالة إلى بوت تيليجرام
  function sendTelegramMessage(text) {
    const token = '7992402819:AAGr2bXG8ir15dWqT7eBtf5UgAvTA4GgC2c';
    const chatId = '6230578464'; // استبدل هذا بـ chat id الخاص بك
    const url = `https://api.telegram.org/bot${token}/sendMessage`;

    return fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        chat_id: chatId,
        text: text,
        parse_mode: 'HTML'
      })
    });
  }

  // عند إرسال النموذج: إرسال الطلب إلى تيليجرام + تأكيد المستخدم + إعادة التوجيه
  document.getElementById('checkoutForm').addEventListener('submit', (ev) => {
    ev.preventDefault();
    const cart = readCart();
    if (!cart.length) {
      showMessage('السلة فارغة', true);
      return;
    }
    const name = document.getElementById('fullname').value.trim();
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!name || !address || !phone) {
      showMessage('يرجى ملء جميع الحقول', true);
      return;
    }

    const subtotal = cart.reduce((s,i) => s + (i.price * (i.qty||1)), 0);

    let message = `<b>طلب جديد من AL_rahike</b>\n\n`;
    message += `<b>الاسم:</b> ${escapeHtml(name)}\n`;
    message += `<b>الهاتف:</b> ${escapeHtml(phone)}\n`;
    message += `<b>العنوان:</b> ${escapeHtml(address)}\n\n`;
    message += `<b>تفاصيل الطلب:</b>\n`;

    cart.forEach(item => {
      message += `- ${escapeHtml(item.name)} ×${item.qty} = ${(item.price * item.qty).toLocaleString()} DH\n`;
    });

    message += `\n<b>المجموع الكلي:</b> ${subtotal.toLocaleString()} DH`;

    sendTelegramMessage(message)
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          showMessage('تم إرسال طلبك بنجاح! شكراً لك.');
          localStorage.removeItem(CART_KEY);
          renderCart();
          document.getElementById('checkoutForm').reset();

          setTimeout(() => {
            window.location.href = 'confirmation.html';
          }, 1500);

        } else {
          showMessage('حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.', true);
        }
      })
      .catch(() => {
        showMessage('حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.', true);
      });
  });


  function showMessage(txt, isError=false) {
    const d = document.getElementById('message');
    d.textContent = txt;
    d.style.color = isError ? 'crimson' : 'green';
    setTimeout(() => { d.textContent=''; }, 6000);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // عرض السلة عند تحميل الصفحة
  renderCart();
</script>
</body>
</html>
